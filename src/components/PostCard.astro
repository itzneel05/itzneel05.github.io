---
import type { CollectionEntry } from "astro:content";
import path from "node:path";
import { Icon } from "astro-icon/components";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import { getDir } from "../utils/url-utils";
import ImageWrapper from "./misc/ImageWrapper.astro";
import PostMetadata from "./PostMeta.astro";

interface Props {
	class?: string;
	entry: CollectionEntry<"posts">;
	title: string;
	url: string;
	published: Date;
	updated?: Date;
	tags: string[];
	category: string | null;
	image: string;
	description: string;
	draft: boolean;
	pinned?: boolean;
	style: string;
}
const {
	entry,
	title,
	url,
	published,
	updated,
	tags,
	category,
	image,
	description,
	pinned,
	style,
} = Astro.props;
const className = Astro.props.class;

const hasCover = image !== undefined && image !== null && image !== "";

const coverWidth = "28%";

const { remarkPluginFrontmatter } = await entry.render();
---
<!-- 3D 透视容器 -->
<div class:list={["card-container w-full relative", className]} style={`${style}; perspective: 2000px;`}>
    <!-- 实际旋转的卡片 -->
    <div class="card-tilt group flex flex-col-reverse md:flex-col w-full rounded-2xl relative"
         style="transform-style: preserve-3d; background-color: color-mix(in srgb, var(--card-bg), transparent 20%);">
        
        <!-- 1. 背景层 -->
        <div class="absolute inset-0 rounded-2xl overflow-hidden backdrop-blur-md border border-white/10 group-hover:border-white/20 transition-colors duration-300 shadow-sm group-hover:shadow-2xl z-0 pointer-events-none">
            <!-- 动态光泽层 -->
            <div class="tilt-glare absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300" 
                 style="background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(255,255,255,0.1) 0%, transparent 50%); mix-blend-mode: overlay;">
            </div>
        </div>

        <!-- 2. 内容层 -->
        <div class:list={["pl-6 md:pl-9 pr-6 md:pr-2 pt-6 md:pt-7 pb-6 relative flex flex-col justify-between h-full z-10 pointer-events-none", {"w-full md:w-[calc(100%_-_52px_-_12px)]": !hasCover, "w-full md:w-[calc(100%_-_var(--coverWidth)_-_12px)]": hasCover}]}
             style="transform: translateZ(30px);">
            <div class="transition-transform duration-300 pointer-events-auto">
                <!-- 标题区域 -->
                <a href={url}
                   class="transition-all duration-300 w-full block font-extrabold mb-3 text-3xl text-90
                hover:text-[var(--primary)] dark:hover:text-[var(--primary)]
                group-hover:translate-x-1
                ">
                    {pinned && <Icon name="mdi:pin" class="inline text-[var(--primary)] text-2xl mr-2 -translate-y-0.5"></Icon>}
                    <span class="bg-clip-text bg-gradient-to-r from-black/90 to-black/70 dark:from-white/90 dark:to-white/70 group-hover:from-[var(--primary)] group-hover:to-[var(--primary)] transition-all duration-300">
                        {title}
                    </span>
                    <Icon class="inline text-[2rem] text-[var(--primary)] md:hidden translate-y-0.5 absolute" name="material-symbols:chevron-right-rounded" ></Icon>
                </a>

                <!-- 元数据胶囊 -->
                <div class="flex flex-wrap gap-2 mb-4 items-center">
                    <PostMetadata published={published} updated={updated} tags={tags} category={category} hideTagsForMobile={true} hideUpdateDate={true} class=""></PostMetadata>
                </div>

                <!-- 摘要 -->
                <div class:list={["transition text-75 mb-3.5 pr-4 leading-relaxed opacity-80 group-hover:opacity-100", {"line-clamp-2 md:line-clamp-2": !description}]}>
                    { description || remarkPluginFrontmatter.excerpt }
                </div>
            </div>

            <!-- 底部信息栏 -->
            <div class="text-sm text-black/30 dark:text-white/30 flex gap-4 transition items-center mt-2 border-t border-black/5 dark:border-white/5 pt-3 w-fit pr-4 pointer-events-auto">
                <div class="flex items-center gap-1">
                    <Icon name="material-symbols:format-list-numbered" class="text-lg"></Icon>
                    {remarkPluginFrontmatter.words} {" " + i18n(remarkPluginFrontmatter.words === 1 ? I18nKey.wordCount : I18nKey.wordsCount)}
                </div>
                <div class="w-[1px] h-3 bg-black/10 dark:bg-white/10"></div>
                <div class="flex items-center gap-1">
                    <Icon name="material-symbols:timer-outline" class="text-lg"></Icon>
                    {remarkPluginFrontmatter.minutes} {" " + i18n(remarkPluginFrontmatter.minutes === 1 ? I18nKey.minuteCount : I18nKey.minutesCount)}
                </div>
            </div>
        </div>

        {hasCover && <a href={url} aria-label={title}
                        class:list={["group/cover",
                            "max-h-[20vh] md:max-h-none mx-4 mt-4 -mb-2 md:mb-0 md:mx-0 md:mt-0",
                            "md:w-[var(--coverWidth)] relative md:absolute md:top-3 md:bottom-3 md:right-3 rounded-xl overflow-hidden active:scale-[0.98] transition-all duration-500 shadow-sm group-hover:shadow-lg z-20"
                        ]} 
                        style="transform: translateZ(50px);">
            <div class="absolute pointer-events-none z-10 w-full h-full group-hover/cover:bg-black/10 transition duration-500"></div>
            
            <!-- 图片遮罩与光效 -->
            <div class="absolute inset-0 z-20 opacity-0 group-hover/cover:opacity-100 transition duration-500 bg-gradient-to-tr from-white/10 to-transparent pointer-events-none"></div>

            <div class="absolute pointer-events-none z-20 w-full h-full flex items-center justify-center ">
                <div class="bg-white/10 backdrop-blur-sm rounded-full p-2 opacity-0 group-hover/cover:opacity-100 scale-50 group-hover/cover:scale-100 transition-all duration-300 shadow-lg border border-white/20">
                    <Icon name="material-symbols:arrow-forward-rounded"
                          class="text-white text-3xl">
                    </Icon>
                </div>
            </div>
            <ImageWrapper src={image} basePath={path.join("content/posts/", getDir(entry.id))} alt="Cover Image of the Post"
                      class="w-full h-full object-cover transition-transform duration-700 group-hover/cover:scale-110">
            </ImageWrapper>
        </a>}

        {!hasCover &&
            <a href={url} aria-label={title} class="!hidden md:!flex btn-regular w-[3.25rem] h-[3.25rem]
             absolute right-6 top-1/2 -translate-y-1/2 rounded-full bg-[var(--enter-btn-bg)]
             hover:bg-[var(--primary)] hover:text-white
             active:scale-95 transition-all duration-300 shadow-md hover:shadow-lg
             items-center justify-center border border-black/5 dark:border-white/10
             group-hover:scale-110 opacity-0 group-hover:opacity-100 translate-x-4 group-hover:translate-x-0 z-20
            "
            style="transform: translateZ(50px);">
                <Icon name="material-symbols:arrow-forward-rounded"
                      class="transition text-2xl">
                </Icon>
            </a>
        }
    </div>
</div>

<script>
    // 3D Tilt Effect - Vanilla Implementation with High Performance
    // 简化版核心逻辑，移除复杂计算，依赖 CSS 3D
    const initTilt = () => {
        const containers = document.querySelectorAll('.card-container');
        
        containers.forEach(container => {
            const card = container.querySelector('.card-tilt') as HTMLElement;
            if (!card) return;

            let bounds: DOMRect;
            let centerX: number;
            let centerY: number;
            let ticking = false;

            // 预计算，减少 move 时的开销
            const updateBounds = () => {
                bounds = container.getBoundingClientRect();
                centerX = bounds.left + bounds.width / 2;
                centerY = bounds.top + bounds.height / 2;
            };

            const rotateToMouse = (e: MouseEvent) => {
                if (!ticking) {
                    window.requestAnimationFrame(() => {
                        updateTransform(e);
                        ticking = false;
                    });
                    ticking = true;
                }
            };

            const updateTransform = (e: MouseEvent) => {
                const mouseX = e.clientX;
                const mouseY = e.clientY;
                const leftX = mouseX - bounds.left;
                const topY = mouseY - bounds.top;

                // 旋转角度
                const rotateX = ((mouseY - centerY) / (bounds.height / 2)) * -10; // 倒置 X 轴
                const rotateY = ((mouseX - centerX) / (bounds.width / 2)) * 10;
                
                // 动态光泽
                card.style.setProperty('--mouse-x', `${leftX}px`);
                card.style.setProperty('--mouse-y', `${topY}px`);

                // 应用变换
                card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`;
            };

            const stopRotate = () => {
                card.style.transition = 'transform 0.5s ease-out';
                card.style.transform = 'rotateX(0) rotateY(0) scale3d(1, 1, 1)';
                setTimeout(() => {
                    card.style.transition = '';
                }, 500);
            };

            container.addEventListener('mouseenter', () => {
                updateBounds();
                card.style.transition = 'none'; // 进入时移除过渡，实现瞬时响应
                document.addEventListener('mousemove', rotateToMouse);
            });

            container.addEventListener('mouseleave', () => {
                document.removeEventListener('mousemove', rotateToMouse);
                stopRotate();
            });
            
            // 窗口调整时更新
            window.addEventListener('resize', updateBounds);
        });
    };

    // 初始化
    initTilt();
    
    // 支持 Astro View Transitions
    document.addEventListener('astro:page-load', initTilt);
    
    // 支持 Swup
    if (window.swup) {
        window.swup.hooks.on('page:view', initTilt);
        window.swup.hooks.on('content:replace', initTilt);
    }
</script>

<style define:vars={{coverWidth}}>
    .card-tilt {
        /* 默认无过渡，由 JS 控制，确保初始状态下 hover 效果正常（如果 JS 未加载） */
        transition: transform 0.3s ease-out, box-shadow 0.3s ease;
        will-change: transform;
    }
    
    /* 提升内部元素层级，增强立体感 - 大幅增加位移 */
    .translate-z-10 {
        transform: translateZ(40px);
    }
    
    .translate-z-12 {
        transform: translateZ(60px);
    }
</style>
