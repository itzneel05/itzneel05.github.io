---
import MainGridLayout from "../layouts/MainGridLayout.astro";
import {
	timelineData,
	getTimelineStats,
	getTimelineByType,
	getCurrentItems,
	getTotalWorkExperience,
} from "../data/timeline";
import { i18n } from "../i18n/translation";
import I18nKey from "../i18n/i18nKey";
import IconifyLoader from "../components/misc/IconifyLoader.astro";
import TimelineStats from "../components/timeline/TimelineStats.astro";
import CurrentTimeline from "../components/timeline/CurrentTimeline.astro";
import TimelineHistory from "../components/timeline/TimelineHistory.astro";
import TimelineCharts from "../components/timeline/TimelineCharts.astro";
import { getTypeIcon, formatDate, getDuration } from "../utils/timeline-utils";

const { lang } = Astro.props;

// 收集所有时间线图标用于预加载
const allIcons = timelineData
	.map((item) => item.icon || getTypeIcon(item.type))
	.filter(Boolean);

// 获取时间线统计信息
const stats = getTimelineStats();
const currentItems = getCurrentItems();
const workExperience = getTotalWorkExperience();

// 获取所有时间线项目（按时间倒序）
const allTimelineItems = getTimelineByType();

const title = i18n(I18nKey.timeline);
const subtitle = i18n(I18nKey.timelineSubtitle);
---

<MainGridLayout title={title} description={subtitle}>
  <!-- 图标加载器，预加载所有时间线图标 -->
  <IconifyLoader preloadIcons={allIcons} />
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <!-- 页面标题 -->
      <div class="flex flex-col items-start justify-center mb-8">
        <h1 class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2">
          {i18n(I18nKey.timeline)}
        </h1>
        <p class="text-lg text-black/60 dark:text-white/60">
          {i18n(I18nKey.timelineSubtitle)}
        </p>
      </div>

      <!-- 统计信息 -->
      <TimelineStats stats={stats} workExperience={workExperience} />

      <CurrentTimeline items={currentItems} getTypeIcon={getTypeIcon} formatDate={formatDate} getDuration={getDuration} />

      <TimelineHistory items={allTimelineItems} getTypeIcon={getTypeIcon} formatDate={formatDate} getDuration={getDuration} />

      <TimelineCharts stats={stats} workExperience={workExperience} currentItems={currentItems} />
    </div>
  </div>
</MainGridLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  // 确保图标库已加载，并处理页面导航
  // 确保图标库已加载
  document.addEventListener('DOMContentLoaded', () => {
    // 如果图标加载器存在，确保图标已加载
    if (window.__iconifyLoader) {
      window.__iconifyLoader.load().catch(error => {
        console.error('Failed to load icons on timeline page:', error);
      });
    }
  });

  // 处理页面导航时的图标重新加载
  if (typeof window !== 'undefined') {
    // 监听页面显示事件（包括前进/后退导航）
    window.addEventListener('pageshow', (event) => {
      if (event.persisted && window.__iconifyLoader) {
        // 页面从缓存恢复，重新检查图标状态
        setTimeout(() => {
          window.__iconifyLoader.load().catch(console.error);
        }, 100);
      }
    });
  }
</script>